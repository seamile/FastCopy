# FastCopy

快速远程文件复制、同步工具。

## 报文设计

所有数据包均采用**大端字节序**

### 1. 报文统一格式

| type  | chksum | length | payload |
| :---: | :----: | :----: | :-----: |
|  1B   |   4B   |   2B   |   ...   |

### 2. 报文类型

1. 首次连接:
    - 拉取申请: `0x01`
    - 推送申请: `0x02`
2. 会话通知: `0x03`
3. 后续连接: `0x04`
4. 文件信息: `0x05`
5. 文件确认: `0x06`
6. 数据传输: `0x07`

### 3. 报文详情

1. 连接报文

    连接建立后，客户端首先需要告诉服务器 *拉取* 或 *推送* 的 *目的路径*

    - Payload 格式为:

        | dest_path |
        | :-------: |
        |    ...    |

2. 建立会话

    服务器收到连接请求后，会产生一个 SessionID，并通过会话报文告知客户端

    - Payload 格式为:

        | session_id |
        | :--------: |
        |     2B     |

3. 后续连接

    客户端后续与服务器建立的并发连接，第一个报文须告诉服务器 SessionID

    - Payload 格式为:

        | session_id |
        | :--------: |
        |     2B     |

4. 文件总量

    文件的发送方需告知接收方文件总量

    - Payload 长度 2 字节，所以最大允许传输文件数量为 65535
    - Payload 格式:

        | n_files |
        | :-----: |
        |   2B    |

5. 文件信息

    - Payload 格式:

        | file_id | perm  | size  | ctime | mtime | atime | path  |
        | :-----: | :---: | :---: | :---: | :---: | :---: | :---: |
        |   2B    |  2B   |  8B   |  8B   |  8B   |  8B   |  ...  |

6. 文件数据块传输报文

    - 变长报文
    - Payload 格式:

        | file_id |  seq  | data  |
        | :-----: | :---: | :---: |
        |   2B    |  4B   |  ...  |

7.  错误回传报文

    |  cmd  |  seq  |
    | :---: | :---: |
    |  1B   |  4B   |


## TODO

- [x] 单个文件写入线程
- [ ] 断点续传时，需记录已完成、未完成的数据块
- [ ] 链接的处理：链接文件如果也在传输的文件中，则保持链接状态，否则直接传输原文件



### 握手阶段

|        客户端        |               服务器               |
| :------------------: | :--------------------------------: |
|      客户端启动      |             服务器启动             |
|     发起连接请求     |                                    |
|                      |  等待客户端命令，三秒无响应则断开  |
|     发送拉取命令     |                                    |
|                      |           产生 SessionID           |
|                      |            整理文件信息            |
|                      | 将 SessionID 和 文件信息传回客户端 |
|      建立空文件      |                                    |
|      开始 recv       |                                    |
|  通知服务器开始发送  |                                    |
| 创建更多线程接收数据 |                                    |
|                      |                                    |
|                      |                                    |

1. 客户端、服务器建立连接
2. 客户端发送 拉取/推送 命令
3. 服务器产生 SessionID，并发送给客户端
4. 客户端建立并发连接，新连接携带 Session
