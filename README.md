SuperSync

## 发送端

1. 统计：目录结构、文件数量、文件大小、文件权限、文件日期
2. 产生卫衣 Session ID，
3. 将 Session ID、

## 报文：

1. 报文分为定长、边长两种

    - 定长报文格式

        | type  | chksum | payload |
        | :---: | :----: | :-----: |
        |  1B   |   4B   |   ...   |

    - 变长报文格式

        | type  | chksum | length | payload |
        | :---: | :----: | :----: | :-----: |
        |  1B   |   4B   |   2B   |   ...   |

2. 报文类型

    1. 拉取数据: 0x01
    2. 推送数据: 0x02
    3. 重传数据: 0x03
    4. 文件信息: 0x04

3. 连接报文

    - Paload 固定长度: 2 字节
    - Payload 格式:

        | session_id |
        | :--------: |
        |     2B     |

4. 文件总量

    - Paload 固定长度: 2 字节
    - Payload 格式:

        | n_files |
        | :-----: |
        |   2B    |

5. 文件信息

    - 变长报文
    - Payload 格式:

        | file_id | perm  | size  | ctime | mtime | atime | path  |
        | :-----: | :---: | :---: | :---: | :---: | :---: | :---: |
        |   2B    |  2B   |  6B   |  4B   |  4B   |  4B   |  ...  |

6. 文件数据块传输报文

    - 变长报文
    - Payload 格式:

        | file_id |  seq  | data  |
        | :-----: | :---: | :---: |
        |   2B    |  4B   |  ...  |

7. 错误回传报文

    |  cmd  |  seq  |
    | :---: | :---: |
    |  1B   |  4B   |


## TODO:

- [x] 单个文件写入线程
- [ ] 断点续传时，需记录已完成、未完成的数据块



## 握手阶段

|        客户端        |               服务器               |
| :------------------: | :--------------------------------: |
|      客户端启动      |             服务器启动             |
|     发起连接请求     |                                    |
|                      |  等待客户端命令，三秒无响应则断开  |
|     发送拉取命令     |                                    |
|                      |           产生 SessionID           |
|                      |            整理文件信息            |
|                      | 将 SessionID 和 文件信息传回客户端 |
|      建立空文件      |                                    |
|      开始 recv       |                                    |
|  通知服务器开始发送  |                                    |
| 创建更多线程接收数据 |                                    |
|                      |                                    |
|                      |                                    |

1. 客户端、服务器建立连接
2. 客户端发送 拉取/推送 命令
3. 服务器产生 SessionID，并发送给客户端
4. 客户端建立并发连接，新连接携带 Session
